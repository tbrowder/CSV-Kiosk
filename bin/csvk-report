#!/usr/bin/env raku
use v6.d;
use CSV::Kiosk::Report :ALL;

# --- config loading helpers -----------------------------------------------

sub read-conf(Str $path --> Hash) {
    return {} unless $path.IO.f && $path.IO.r;
    my %cfg;
    for $path.IO.lines -> $line {
        next if $line ~~ /^\s*$/;          # blank
        next if $line ~~ /^\s* '#' /;      # comment
        if $line ~~ /^ \s* (\w+) \s* '=' \s* (.*) \s* $/ {
            my $k = ~$0;
            my $v = ~$1;
            if $v ~~ /^"(.*)"$/ { $v = ~$0 }
            elsif $v ~~ /^\'(.*)\'$/ { $v = ~$0 }
            %cfg{$k} = $v.trim;
        }
    }
    %cfg
}

sub load-config(--> Hash) {
    my @candidates = (
        %*ENV<HOME> ~ '/.csvk-report.conf',
        $*CWD ~ '/csvk-report.conf',
    );
    my %merged;
    for @candidates -> $p {
        %merged{$_.key} = $_.value for read-conf($p).pairs;
    }
    %merged
}

# --------------------------------------------------------------------------

sub USAGE() {
    say q:to/END/;
Usage:
  bin/csvk-report sort --csv=<file> [--by=<hdr>] [--sep=<c>] [--out=<file>] [--numeric] [--reverse]
  bin/csvk-report --csv=<file> sort [--by=<hdr>] [--sep=<c>] [--out=<file>] [--numeric] [--reverse]
  bin/csvk-report pdf  --csv=<file> --out=<pdf> [--title=<s>] [--sep=<c>]
  bin/csvk-report --csv=<file> --out=<pdf> [--title=<s>] [--sep=<c>] pdf
END
}

sub MAIN(
    Str :$csv,
    Str :$out,
    Str :$by,
    Str :$sep,
    Str :$title,
    Bool :$numeric = False,
    Bool :$reverse = False,
    *@cmd,
) {
    my %cfg = load-config();

    my $csvv   = $csv   // %cfg<csv>;
    my $outv   = $out   // %cfg<out>;
    my $byv    = $by    // %cfg<by>;
    my $sepv   = $sep   // %cfg<sep> // ',';
    my $titlev = $title // %cfg<title>;

    if @cmd.elems == 0 {
        USAGE();
        exit 2;
    }
    my $subcmd = @cmd[0];
    given $subcmd {
        when 'sort' {
            unless $csvv.defined {
                note "csvk-report: --csv not provided and no 'csv' in config";
                exit 2;
            }
            my %args = :csv($csvv), :sep($sepv), :$numeric, :$reverse;
            %args<by>  = $byv   if $byv.defined;
            %args<out> = $outv  if $outv.defined;
            my $code = sort-csv(|%args);
            exit $code;
        }
        when 'pdf' {
            unless $csvv.defined && $outv.defined {
                note "csvk-report: pdf requires --csv and --out (or config keys 'csv' and 'out')";
                exit 2;
            }
            my %args = :csv($csvv), :out($outv);
            %args<title> = $titlev if $titlev.defined;
            my $code = generate-pdf(|%args);
            exit $code;
        }
        default {
            USAGE();
            exit 2;
        }
    }
}
